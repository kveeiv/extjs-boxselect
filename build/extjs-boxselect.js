Ext.define("Ext.ux.layout.component.field.BoxSelectField",{alias:["layout.boxselectfield"],extend:"Ext.layout.component.field.Trigger",type:"boxselectfield",waitForOuterWidthInDom:true,beginLayout:function(c){var b=this,a=b.owner;b.callParent(arguments);c.inputElCtContext=c.getEl("inputElCt");a.inputElCt.setStyle("width","");b.skipInputGrowth=!a.grow||!a.multiSelect},beginLayoutFixed:function(d,b,e){var c=this,a=d.target;a.triggerEl.setStyle("height","24px");c.callParent(arguments);if(d.heightModel.fixed&&d.lastBox){a.listWrapper.setStyle("height",d.lastBox.height+"px");a.itemList.setStyle("height","100%")}},publishInnerWidth:function(e){var d=this,a=d.owner,c=a.itemList.getWidth(true)-10,b=a.inputElCt.prev(null,true);if(b&&!a.stacked){b=Ext.fly(b);c=c-b.getOffsetsTo(b.up(""))[0]-b.getWidth()}if(!d.skipInputGrowth&&(c<35)){c=c-10}else{if(c<1){c=1}}e.inputElCtContext.setWidth(c)}});Ext.define("Ext.ux.form.field.BoxSelect",{extend:"Ext.form.field.ComboBox",alias:["widget.comboboxselect","widget.boxselect"],requires:["Ext.selection.Model","Ext.data.Store","Ext.ux.layout.component.field.BoxSelectField"],multiSelect:true,forceSelection:true,createNewOnEnter:false,createNewOnBlur:false,encodeSubmitValue:false,triggerOnClick:true,stacked:false,pinList:true,filterPickList:false,selectOnFocus:true,grow:true,growMin:false,growMax:false,fieldSubTpl:['<div id="{cmpId}-listWrapper" class="x-boxselect {fieldCls} {typeCls}">','<ul id="{cmpId}-itemList" class="x-boxselect-list">','<li id="{cmpId}-inputElCt" class="x-boxselect-input">','<div id="{cmpId}-emptyEl" class="{emptyCls}">{emptyText}</div>','<input id="{cmpId}-inputEl" type="{type}" ','<tpl if="name">name="{name}" </tpl>','<tpl if="value"> value="{[Ext.util.Format.htmlEncode(values.value)]}"</tpl>','<tpl if="size">size="{size}" </tpl>','<tpl if="tabIdx">tabIndex="{tabIdx}" </tpl>','<tpl if="disabled"> disabled="disabled"</tpl>','class="x-boxselect-input-field {inputElCls}" autocomplete="off">',"</li>","</ul>","</div>",{compiled:true,disableFormats:true}],childEls:["listWrapper","itemList","inputEl","inputElCt","emptyEl"],componentLayout:"boxselectfield",emptyInputCls:"x-boxselect-emptyinput",initComponent:function(){var b=this,a=b.typeAhead;if(a&&!b.editable){Ext.Error.raise("If typeAhead is enabled the combo must be editable: true -- please change one of those settings.")}Ext.apply(b,{typeAhead:false});b.callParent();b.typeAhead=a;b.selectionModel=new Ext.selection.Model({store:b.valueStore,mode:"MULTI",lastFocused:null,onSelectChange:function(c,e,d,f){f()}});if(!Ext.isEmpty(b.delimiter)&&b.multiSelect){b.delimiterRegexp=new RegExp(String(b.delimiter).replace(/[$%()*+.?\[\\\]{|}]/g,"\\$&"))}},initEvents:function(){var a=this;a.callParent(arguments);if(!a.enableKeyEvents){a.mon(a.inputEl,"keydown",a.onKeyDown,a)}a.mon(a.inputEl,"paste",a.onPaste,a);a.mon(a.listWrapper,"click",a.onItemListClick,a);a.mon(a.selectionModel,{selectionchange:function(b,c){a.applyMultiselectItemMarkup();a.fireEvent("valueselectionchange",a,c)},focuschange:function(b,d,c){a.fireEvent("valuefocuschange",a,d,c)},scope:a})},onBindStore:function(a,b){var c=this;if(a){c.valueStore=new Ext.data.Store({model:a.model,proxy:{type:"memory"}});c.mon(c.valueStore,"datachanged",c.applyMultiselectItemMarkup,c);if(c.selectionModel){c.selectionModel.bindStore(c.valueStore)}}},onUnbindStore:function(a){var b=this,c=b.valueStore;if(c){if(b.selectionModel){b.selectionModel.setLastFocused(null);b.selectionModel.deselectAll();b.selectionModel.bindStore(null)}b.mun(c,"datachanged",b.applyMultiselectItemMarkup,b);c.destroy();b.valueStore=null}b.callParent(arguments)},createPicker:function(){var b=this,a=b.callParent(arguments);b.mon(a,{beforerefresh:b.onBeforeListRefresh,scope:b});if(b.filterPickList){a.addCls("x-boxselect-hideselections")}return a},onDestroy:function(){var a=this;Ext.destroyMembers(a,"valueStore","selectionModel");a.callParent(arguments)},getSubTplData:function(){var a=this,b=a.callParent(),c=a.emptyText&&b.value.length<1;b.value="";if(c){b.emptyText=a.emptyText;b.emptyCls=a.emptyCls;b.inputElCls=a.emptyInputCls}else{b.emptyText="";b.emptyCls=a.emptyInputCls;b.inputElCls=""}return b},afterRender:function(){var a=this;if(Ext.supports.Placeholder&&a.inputEl&&a.emptyText){delete a.inputEl.dom.placeholder}a.bodyEl.applyStyles("vertical-align:top");if(a.grow){if(Ext.isNumber(a.growMin)&&(a.growMin>0)){a.listWrapper.applyStyles("min-height:"+a.growMin+"px")}if(Ext.isNumber(a.growMax)&&(a.growMax>0)){a.listWrapper.applyStyles("max-height:"+a.growMax+"px")}}if(a.stacked===true){a.itemList.addCls("x-boxselect-stacked")}if(!a.multiSelect){a.itemList.addCls("x-boxselect-singleselect")}a.applyMultiselectItemMarkup();a.callParent(arguments)},findRecord:function(d,c){var b=this.store,a;if(!b){return false}a=b.queryBy(function(e,f){return e.isEqual(e.get(d),c)});return(a.getCount()>0)?a.first():false},onLoad:function(){var b=this,a=b.valueField,c=b.valueStore,d=false;if(c){if(!Ext.isEmpty(b.value)&&(c.getCount()==0)){b.setValue(b.value,false,true)}c.suspendEvents();c.each(function(g){var f=b.findRecord(a,g.get(a)),e=f?c.indexOf(g):-1;if(e>=0){c.removeAt(e);c.insert(e,f);d=true}});c.resumeEvents();if(d){c.fireEvent("datachanged",c)}}b.callParent(arguments)},isFilteredRecord:function(a){var c=this,b=c.valueField,d=a.get(b);return(c.store.findExact(b,d)===-1)&&(c.valueStore.findExact(b,d)!==-1)},doRawQuery:function(){var a=this,b=a.inputEl.dom.value;if(a.multiSelect){b=b.split(a.delimiter).pop()}this.doQuery(b,false,true)},onBeforeListRefresh:function(){this.ignoreSelection++},onListRefresh:function(){this.callParent(arguments);if(this.ignoreSelection>0){--this.ignoreSelection}},onListSelectionChange:function(c,f){var b=this,d=b.valueStore,e=[],a;if((b.ignoreSelection<=0)&&b.isExpanded){d.each(function(g){if(Ext.Array.contains(f,g)||b.isFilteredRecord(g)){e.push(g)}});e=Ext.Array.merge(e,f);a=Ext.Array.intersect(e,d.getRange()).length;if((a!=e.length)||(a!=b.valueStore.getCount())){b.setValue(e,false);if(!b.multiSelect||!b.pinList){Ext.defer(b.collapse,1,b)}if(d.getCount()>0){b.fireEvent("select",b,d.getRange())}}b.inputEl.focus();if(!b.pinList){b.inputEl.dom.value=""}if(b.selectOnFocus){b.inputEl.dom.select()}}},syncSelection:function(){var f=this,d=f.picker,c=f.valueField,a,e,b;if(d){a=d.store;e=[];if(f.valueStore){f.valueStore.each(function(h){var g=a.findExact(c,h.get(c));if(g>=0){e.push(a.getAt(g))}})}f.ignoreSelection++;b=d.getSelectionModel();b.deselectAll();if(e.length>0){b.select(e)}if(f.ignoreSelection>0){--f.ignoreSelection}}},doAlign:function(){var d=this,c=d.picker,a="-above",b;d.picker.alignTo(d.listWrapper,d.pickerAlign,d.pickerOffset);b=c.el.getY()<d.inputEl.getY();d.bodyEl[b?"addCls":"removeCls"](d.openCls+a);c[b?"addCls":"removeCls"](c.baseCls+a)},alignPicker:function(){var c=this,b=c.picker,a=b.getTargetEl().dom.scrollTop;c.callParent(arguments);if(c.isExpanded){if(c.matchFieldWidth){b.setWidth(c.listWrapper.getWidth())}b.getTargetEl().dom.scrollTop=a}},getCursorPosition:function(){var a;if(Ext.isIE){a=document.selection.createRange();a.collapse(true);a.moveStart("character",-this.inputEl.dom.value.length);a=a.text.length}else{a=this.inputEl.dom.selectionStart}return a},hasSelectedText:function(){var b,a;if(Ext.isIE){b=document.selection;a=b.createRange();return(a.parentElement()==this.inputEl.dom)}else{return this.inputEl.dom.selectionStart!=this.inputEl.dom.selectionEnd}},onKeyDown:function(d,i){var f=this,h=d.getKey(),b=f.inputEl.dom.value,j=f.valueStore,c=f.selectionModel,a=false;if(f.readOnly||f.disabled||!f.editable){return}if(f.isExpanded&&(h==d.A&&d.ctrlKey)){f.select(f.getStore().getRange());c.setLastFocused(null);c.deselectAll();f.collapse();f.inputEl.focus();a=true}else{if((j.getCount()>0)&&((b=="")||((f.getCursorPosition()===0)&&!f.hasSelectedText()))){var g=(c.getCount()>0)?j.indexOf(c.getLastSelected()||c.getLastFocused()):-1;if((h==d.BACKSPACE)||(h==d.DELETE)){if(g>-1){if(c.getCount()>1){g=-1}f.valueStore.remove(c.getSelection())}else{f.valueStore.remove(f.valueStore.last())}c.clearSelections();f.setValue(f.valueStore.getRange());if(g>0){c.select(g-1)}a=true}else{if((h==d.RIGHT)||(h==d.LEFT)){if((g==-1)&&(h==d.LEFT)){c.select(j.last());a=true}else{if(g>-1){if(h==d.RIGHT){if(g<(j.getCount()-1)){c.select(g+1,d.shiftKey);a=true}else{if(!d.shiftKey){c.setLastFocused(null);c.deselectAll();a=true}}}else{if((h==d.LEFT)&&(g>0)){c.select(g-1,d.shiftKey);a=true}}}}}else{if(h==d.A&&d.ctrlKey){c.selectAll();a=d.A}}}f.inputEl.focus()}}if(a){f.preventKeyUpEvent=a;d.stopEvent();return}if(f.isExpanded&&(h==d.ENTER)&&f.picker.highlightedItem){f.preventKeyUpEvent=true}if(f.enableKeyEvents){f.callParent(arguments)}if(!d.isSpecialKey()&&!d.hasModifier()){f.selectionModel.setLastFocused(null);f.selectionModel.deselectAll();f.inputEl.focus()}},onKeyUp:function(d,a){var b=this,c=b.inputEl.dom.value;if(b.preventKeyUpEvent){d.stopEvent();if((b.preventKeyUpEvent===true)||(d.getKey()===b.preventKeyUpEvent)){delete b.preventKeyUpEvent}return}if(b.multiSelect&&(b.delimiterRegexp&&b.delimiterRegexp.test(c))||((b.createNewOnEnter===true)&&d.getKey()==d.ENTER)){c=Ext.Array.clean(c.split(b.delimiterRegexp));b.inputEl.dom.value="";b.setValue(b.valueStore.getRange().concat(c));b.inputEl.focus()}b.callParent([d,a])},onPaste:function(f,a){var b=this,d=b.inputEl.dom.value,c=(f&&f.browserEvent&&f.browserEvent.clipboardData)?f.browserEvent.clipboardData:false;if(b.multiSelect&&(b.delimiterRegexp&&b.delimiterRegexp.test(d))){if(c&&c.getData){if(/text\/plain/.test(c.types)){d=c.getData("text/plain")}else{if(/text\/html/.test(c.types)){d=c.getData("text/html")}}}d=Ext.Array.clean(d.split(b.delimiterRegexp));b.inputEl.dom.value="";b.setValue(b.valueStore.getRange().concat(d));b.inputEl.focus()}},onExpand:function(){var b=this,a=b.listKeyNav;b.callParent(arguments);if(a||!b.filterPickList){return}a=b.listKeyNav;a.highlightAt=function(e){var d=this.boundList,f=d.all.item(e),c=d.all.getCount(),g;if(f&&f.hasCls("x-boundlist-selected")){if((e==0)||!d.highlightedItem||(d.indexOf(d.highlightedItem)<e)){g=1}else{g=-1}do{e=e+g;f=d.all.item(e)}while((e>0)&&(e<c)&&f.hasCls("x-boundlist-selected"));if(f.hasCls("x-boundlist-selected")){return}}if(f){f=f.dom;d.highlightItem(f);d.getTargetEl().scrollChildIntoView(f,false)}}},onTypeAhead:function(){var f=this,e=f.displayField,h=f.inputEl.dom,j=f.valueStore,i=f.getPicker(),c,a,d,b;if(f.filterPickList){var g=f.store.createFilterFn(e,h.value);c=f.store.findBy(function(k){return((j.indexOfId(k.getId())===-1)&&(!g||g(k)))});c=(c===-1)?false:f.store.getAt(c)}else{c=f.store.findRecord(e,h.value)}if(c){a=c.get(e);d=a.length;b=h.value.length;i.highlightItem(i.getNode(c));if(b!==0&&b!==d){h.value=a;f.selectText(b,a.length)}}},onItemListClick:function(a,c,e){var d=this,b=a.getTarget(".x-boxselect-item"),f=b?a.getTarget(".x-boxselect-item-close"):false;if(d.readOnly||d.disabled){return}a.stopPropagation();if(b){if(f){d.removeByListItemNode(b);if(d.valueStore.getCount()>0){d.fireEvent("select",d,d.valueStore.getRange())}}else{d.toggleSelectionByListItemNode(b,a.shiftKey)}d.inputEl.focus()}else{if(d.selectionModel.getCount()>0){d.selectionModel.setLastFocused(null);d.selectionModel.deselectAll()}if(d.triggerOnClick){d.onTriggerClick()}}},getMultiSelectItemMarkup:function(){var a=this;if(!a.multiSelectItemTpl){if(!a.labelTpl){a.labelTpl=Ext.create("Ext.XTemplate","{[values."+a.displayField+"]}")}else{if(Ext.isString(a.labelTpl)||Ext.isArray(a.labelTpl)){a.labelTpl=Ext.create("Ext.XTemplate",a.labelTpl)}}a.multiSelectItemTpl=['<tpl for=".">','<li class="x-tab-default x-boxselect-item ','<tpl if="this.isSelected(values.'+a.valueField+')">'," selected","</tpl>",'" qtip="{[typeof values === "string" ? values : values.'+a.displayField+']}">','<div class="x-boxselect-item-text">{[typeof values === "string" ? values : this.getItemLabel(values)]}</div>','<div class="x-tab-close-btn x-boxselect-item-close"></div>',"</li>","</tpl>",{compile:true,disableFormats:true,isSelected:function(c){var b=a.valueStore.findExact(a.valueField,c);if(b>=0){return a.selectionModel.isSelected(a.valueStore.getAt(b))}return false},getItemLabel:function(b){return a.getTpl("labelTpl").apply(b)}}]}return this.getTpl("multiSelectItemTpl").apply(Ext.Array.pluck(this.valueStore.getRange(),"data"))},applyMultiselectItemMarkup:function(){var c=this,a=c.itemList,b;if(a){while((b=c.inputElCt.prev())!=null){b.remove()}c.inputElCt.insertHtml("beforeBegin",c.getMultiSelectItemMarkup())}Ext.Function.defer(function(){if(c.picker&&c.isExpanded){c.alignPicker()}if(c.hasFocus&&c.inputElCt&&c.listWrapper){c.inputElCt.scrollIntoView(c.listWrapper)}},15)},getRecordByListItemNode:function(b){var d=this,c=0,a=d.itemList.dom.firstChild;while(a&&a.nextSibling){if(a==b){break}c++;a=a.nextSibling}c=(a==b)?c:false;if(c===false){return false}return d.valueStore.getAt(c)},toggleSelectionByListItemNode:function(b,d){var c=this,e=c.getRecordByListItemNode(b),a=c.selectionModel;if(e){if(a.isSelected(e)){if(a.isFocused(e)){a.setLastFocused(null)}a.deselect(e)}else{a.select(e,d)}}},removeByListItemNode:function(a){var b=this,c=b.getRecordByListItemNode(a);if(c){b.valueStore.remove(c);b.setValue(b.valueStore.getRange())}},getRawValue:function(){var b=this,c=b.inputEl,a;b.inputEl=false;a=b.callParent(arguments);b.inputEl=c;return a},setRawValue:function(c){var b=this,d=b.inputEl,a;b.inputEl=false;a=b.callParent([c]);b.inputEl=d;return a},addValue:function(b){var a=this;if(b){a.setValue(Ext.Array.merge(a.value,Ext.Array.from(b)))}},removeValue:function(b){var a=this;if(b){a.setValue(Ext.Array.difference(a.value,Ext.Array.from(b)))}},setValue:function(l,b,m){var k=this,o=k.valueStore,n=k.valueField,f,g,d,a,e,j=[];if(Ext.isEmpty(l)){l=null}if(Ext.isString(l)&&k.multiSelect){l=l.split(k.delimiter)}l=Ext.Array.from(l,true);for(d=0,g=l.length;d<g;d++){f=l[d];if(!f||!f.isModel){a=o.findExact(n,f);if(a>=0){l[d]=o.getAt(a)}else{a=k.findRecord(n,f);if(!a){if(k.forceSelection){j.push(f)}else{a={};a[k.valueField]=f;a[k.displayField]=f;a=new k.valueStore.model(a)}}if(a){l[d]=a}}}}if((m!==true)&&(j.length>0)&&(k.queryMode==="remote")){var c={};c[k.valueParam||k.valueField]=j.join(k.delimiter);k.store.load({params:c,callback:function(){if(k.itemList){k.itemList.unmask()}k.setValue(l,b,true);k.autoSize();k.lastQuery=false}});return false}if(!k.multiSelect&&(l.length>0)){for(d=l.length-1;d>=0;d--){if(l[d].isModel){l=l[d];break}}if(Ext.isArray(l)){l=l[l.length-1]}}return k.callParent([l,b])},getValueRecords:function(){return this.valueStore.getRange()},getSubmitData:function(){var a=this,b=a.callParent(arguments);if(a.multiSelect&&a.encodeSubmitValue&&b&&b[a.name]){b[a.name]=Ext.encode(b[a.name])}return b},mimicBlur:function(){var a=this;if(a.selectOnTab&&a.picker&&a.picker.highlightedItem){a.inputEl.dom.value=""}a.callParent(arguments)},assertValue:function(){var a=this,c=a.inputEl.dom.value,d=!Ext.isEmpty(c)?a.findRecordByDisplay(c):false,b=false;if(!d&&!a.forceSelection&&a.createNewOnBlur&&!Ext.isEmpty(c)){b=c}else{if(d){b=d}}if(b){a.addValue(b)}a.inputEl.dom.value="";a.collapse()},checkChange:function(){if(!this.suspendCheckChange&&!this.isDestroyed){var c=this,f=c.valueStore,b=c.lastValue||"",a=c.valueField,e=Ext.Array.map(Ext.Array.from(c.value),function(g){if(g.isModel){return g.get(a)}return g},this).join(this.delimiter),d=c.isEqual(e,b);if(!d||((e.length>0&&f.getCount()<e.length))){f.suspendEvents();f.removeAll();if(Ext.isArray(c.valueModels)){f.add(c.valueModels)}f.resumeEvents();f.fireEvent("datachanged",f);if(!d){c.lastValue=e;c.fireEvent("change",c,e,b);c.onChange(e,b)}}}},isEqual:function(h,g){var b=Ext.Array.from,c=this.valueField,d,a,f,e;h=b(h);g=b(g);a=h.length;if(a!==g.length){return false}for(d=0;d<a;d++){f=h[d].isModel?h[d].get(c):h[d];e=g[d].isModel?g[d].get(c):g[d];if(f!==e){return false}}return true},applyEmptyText:function(){var b=this,a=b.emptyText,c,d;if(b.rendered&&a){d=Ext.isEmpty(b.value)&&!b.hasFocus;c=b.inputEl;if(d){c.dom.value="";b.emptyEl.update(a);b.emptyEl.addCls(b.emptyCls);b.emptyEl.removeCls(b.emptyInputCls);b.listWrapper.addCls(b.emptyCls);b.inputEl.addCls(b.emptyInputCls)}else{b.emptyEl.addCls(b.emptyInputCls);b.emptyEl.removeCls(b.emptyCls);b.listWrapper.removeCls(b.emptyCls);b.inputEl.removeCls(b.emptyInputCls)}b.autoSize()}},preFocus:function(){var b=this,c=b.inputEl,a=b.emptyText,d=(c.dom.value=="");b.emptyEl.addCls(b.emptyInputCls);b.emptyEl.removeCls(b.emptyCls);b.listWrapper.removeCls(b.emptyCls);b.inputEl.removeCls(b.emptyInputCls);if(b.selectOnFocus||d){c.dom.select()}},onFocus:function(){var c=this,b=c.focusCls,a=c.itemList;if(b&&a){a.addCls(b)}c.callParent(arguments)},onBlur:function(){var c=this,b=c.focusCls,a=c.itemList;if(b&&a){a.removeCls(b)}c.callParent(arguments)},renderActiveError:function(){var d=this,c=d.invalidCls,b=d.itemList,a=d.hasActiveError();if(c&&b){b[a?"addCls":"removeCls"](d.invalidCls+"-field")}d.callParent(arguments)},autoSize:function(){var b=this,a;if(b.grow&&b.rendered){b.autoSizing=true;b.updateLayout()}return b},afterComponentLayout:function(){var b=this,a;if(b.autoSizing){height=b.getHeight();if(height!==b.lastInputHeight){if(b.isExpanded){b.alignPicker()}b.fireEvent("autosize",b,height);b.lastInputHeight=height;delete b.autoSizing}}}});